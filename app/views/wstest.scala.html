@(webSocketPort: String, sessionId: String)
@main("Web Socket Test Page") {
    
<script type="text/javascript" charset="utf-8">
var absenceNS = new function() {
	/* Absence Model */
	var Absence = Backbone.Model.extend({
		defaults : function() {
			return {
				userId : -1,
				description : "-description-",
				start : 100,
				end : 200
			}
		},
		url: '/absence'
	})
	/* User Model */
	var User = Backbone.Model.extend({
		defaults : function() {
			return {
				name : "default name"
			};
		},
		url: '/user'
	})
	
	/* List of User models List[User] */
	var Users = Backbone.Collection.extend({
		model : User
	})

	/* List of Absence models List[Absence] */
	var Absences = Backbone.Collection.extend({
		model : Absence
	})

	var users = new Users()
	var absences = new Absences()

	var incommingUser = function(user) {
		var existingUser = users.get(user.id)
		if (existingUser) {
			existingUser.set({name: user.name})
		} else {
			users.add(new User(user))
		}
	}
	
	var incommingAbsence = function(absence) {
		var existingAbsence = absences.get(absence.id)
		if (existingAbsence) {
			existingAbsence.set({description: existingAbsence.name})
		} else {
			absences.add(new Absence(absence))
		}
	}

	var receiveEvent = function(jsonString) {
		$("#log").append("<div>" + jsonString + "</div>")
		var json = JSON.parse(jsonString)
		if (json.user) {
			incommingUser(json.user)
		} else if (json.userList) {
			var i = 0
			for(; i < json.userList.length; i++) {
				incommingUser(json.userList[i])
			}
		} else if (json.absence) {
			incommingAbsence(json.absence)
		} else if (json.absenceList) {
			var i = 0
			for(; i < json.absenceList.length; i++) {
				incommingAbsence(json.absenceList[i])
			}
		} else if (json.userDelete) {
			users.remove({id: json.userDelete.id})
		} else if (json.absenceDelete) {
			absences.remove({id: json.absenceDelete.id})
		}
	}
	var onopen = function() {
		console.log("connected")
		$("#log").append("<div>connected</div>")
	}
	
	var sendMessage = function(endpoint, json) {
		sendMessage(endpoint, json, "POST")
	}
	
	var sendMessage = function(endpoint, json, method) {
		var jsonString = JSON.stringify(json)
		console.log("sending to: " + endpoint + " -> " + jsonString)
		var result = $.ajax({
			type : method,
			contentType : "application/json",
			url : endpoint,
			async : false,
			data : jsonString
		})
		console.log("synchronous response: " + result.responseText)
		return result
	}
	
	var cometFallback = function() {
		$("#log").append("<iframe src='/comet/@sessionId'></iframe>");
	}
	this.cometMessage = function(event) {
		receiveEvent(event)
		console.log('Received comet event: ' + event)
	}

	this.init = function() {
		var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
		var absenceSocket = new WS("ws://" + location.hostname + ":@webSocketPort/connect/@sessionId")
		console.log(absenceSocket)
		absenceSocket.onmessage = function(message) { receiveEvent(message.data) }
		absenceSocket.onopen = onopen
		absenceSocket.onclose = cometFallback

		/* User View */
		var UserView = Backbone.View.extend({
			tagName : "li",
			template: _.template($('#user-template').html()),
			events : {
				"click .liUserName"   : "edit",
				"click .liUserDelete" : "delete"
			},
			initialize : function() {
				this.model.bind('change', this.render, this);
				this.model.bind('remove', this.remove, this);
			},
			render : function() {
				this.$el.html(this.template(this.model.toJSON()));
				return this;
			},
			edit : function() {
				var newName = prompt("Please enter new name")
				if (newName) {
					this.model.set({name: newName})
					this.model.save()
				}
			},
			delete: function() {
				// this.model.destory() should work but is missing id?
				sendMessage("/user/" + this.model.id, "{}", "DELETE")
			}
		});
		/* Absence View */
		var AbsenceView = Backbone.View.extend({
			tagName : "li",
			template: _.template($('#absence-template').html()),
			events : {
				"click .liAbsenceDescription" : "edit",
				"click .liAbsenceDelete" : "delete"
			},
			initialize : function() {
				this.model.bind('change', this.render, this)
				this.model.bind('remove', this.remove, this)
			},
			render : function() {
				this.$el.html(this.template(this.model.toJSON()));
				return this;
			},
			edit : function() {
				var newDescription = prompt("Please enter new description for Absence")
				if (newDescription) {
					this.model.set({description: newDescription})
					this.model.save()
				}
			},
			delete: function() {
				// this.model.destory() should work but is missing id?
				sendMessage("/absence/" + this.model.id, "{}", "DELETE")
			}
		});
		
		$("#newUserRequestButton").click(function() {
			new User({name: $("#newUserRequestName").val()}).save()
		});
		$("#allUsersRequestButton").click(function() {
			var allUsersRequest = {}
			var endpoint = "/user"
			sendMessage(endpoint, allUsersRequest, "GET")
		});
		$("#allAbsenceRequestButton").click(function() {
			var allAbsenceRequest = {}
			var endpoint = "/absence"
			sendMessage(endpoint, allAbsenceRequest, "GET")
		});
		$("#newAbsenceRequestButton").click(function() {
			new Absence({
				userId : parseInt($("#newAbsenceRequestUserId").val()),
				description : $("#newAbsenceRequestDescription").val(),
				start : parseInt($("#newAbsenceRequestStart").val()),
				end : parseInt($("#newAbsenceRequestEnd").val())
			}).save()
		});
		$("#currentWeekRequestButton").click(function() {
		    var currentWeekRequest = {}
		    var endpoint = "/view/current"
		    sendMessage(endpoint, currentWeekRequest, "GET")
		});
		
		users.on("add", function(user) {
			var view = new UserView({
				model : user
			});
			$("#user-list").append(view.render().el);
		})

		absences.on("add", function(absence) {
			var view = new AbsenceView({
				model : absence
			});
			$("#absence-list").append(view.render().el);
		})
	}
}
$(function() {
	absenceNS.init()
})
</script>
<script type="text/template" id="user-template">
	<li>
		<span><%= id %> - </span>
		<span class="liUserName"><%= name %></span>
		<a class="liUserDelete" style="colour:red" href="#">X</a></li>
</script>
<script type="text/template" id="absence-template">
	<li>
		<span><%= id %> - </span>
		<span class="liAbsenceDescription"><%= description %></span>
		<a class="liAbsenceDelete" style="colour:red" href="#">X</a></li>
</script>


	<div>
    	<ul id="user-list"></ul>
    	<ul id="absence-list"></ul>
    </div>
    <div id="newUserRequestDiv"  style=" border : 2px dotted red">
    	<div>Name: <input type="text" id="newUserRequestName"></div>
    	<button id="newUserRequestButton">create user</button>
    </div>
    <div id="allUsersRequestDiv"  style=" border : 2px dotted pink">
    	<button id="allUsersRequestButton">get all users</button>
    </div>
    <div id="newAbsenceRequestDiv"  style=" border : 2px dotted blue">
    	<div>UserId: <input type="text" id="newAbsenceRequestUserId"></div>
    	<div>Description: <input type="text" id="newAbsenceRequestDescription"></div>
    	<div>Start: <input type="text" id="newAbsenceRequestStart"></div>
    	<div>End: <input type="text" id="newAbsenceRequestEnd"></div>
    	<button id="newAbsenceRequestButton">create absence</button>
    </div>
    <div id="allAbsenceRequestDiv"  style=" border : 2px dotted green">
    	<button id="allAbsenceRequestButton">get all absence</button>
    </div>
    <div id="currentWeekRequestDiv"  style=" border : 2px dotted purple">
      <button id="currentWeekRequestButton">get current week</button>
    </div>
    <div id="log"></div>
}